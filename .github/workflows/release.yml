name: Release build

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up CMake
      uses: jwlawson/actions-setup-cmake@v2

    - name: Configure
      run: |
        mkdir -p build
        cd build
        # Build embedded single-exe binaries per platform so artifacts are all-in-one
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          cmake .. -DBUILD_SINGLE_EXE=ON -DCMAKE_BUILD_TYPE=Release
        elif [ "${{ matrix.os }}" = "windows-latest" ]; then
          cmake .. -DBUILD_WINDOWS_SINGLE_EXE=ON -DCMAKE_BUILD_TYPE=Release
        else
          # macOS
          cmake .. -DBUILD_SINGLE_EXE=ON -DCMAKE_BUILD_TYPE=Release
        fi

    - name: Build
      run: |
        cd build
        cmake --build . --config Release -- -j$(nproc || echo 2)

    - name: Package (Linux AppImage)
      if: matrix.os == 'ubuntu-latest'
      run: |
        cd build
        ../scripts/build_appimage.sh build Standalone
        ls -l Standalone || true

    - name: Package (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        cd build/Release || cd build
        # Copy exe to artifacts dir
        mkdir -p $GITHUB_WORKSPACE/artifacts
        if [ -f Watercan.exe ]; then cp Watercan.exe $GITHUB_WORKSPACE/artifacts/Watercan-windows.exe; fi

    - name: Package (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        cd build
        mkdir -p $GITHUB_WORKSPACE/artifacts
        # binary likely at ./Watercan or ./bin/Watercan
        if [ -f Watercan ]; then cp Watercan $GITHUB_WORKSPACE/artifacts/Watercan-macos; fi
        if [ -f bin/Watercan ]; then cp bin/Watercan $GITHUB_WORKSPACE/artifacts/Watercan-macos; fi

    - name: Create GitHub Release
      id: create_release
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ github.ref_name }}
        name: ${{ github.ref_name }}
        body: |-
          Release ${{ github.ref_name }}
          - Cross-platform builds
        draft: false
        prerelease: false

    - name: Prepare artifacts zip
      run: |
        mkdir -p $GITHUB_WORKSPACE/artifacts
        if [ -d $GITHUB_WORKSPACE/artifacts ]; then
          cd $GITHUB_WORKSPACE
          zip -r ${matrix.os}-artifacts.zip artifacts || true
        fi

    - name: Upload artifacts
      uses: actions/upload-release-asset@v2
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ github.workspace }}/${{ matrix.os }}-artifacts.zip
        asset_name: ${{ matrix.os }}-artifacts.zip
        asset_content_type: application/zip
      continue-on-error: true

    - name: Upload AppImage (Linux only)
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-release-asset@v2
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: build/Standalone/Watercan.AppImage
        asset_name: Watercan.AppImage
        asset_content_type: application/octet-stream
      continue-on-error: true
